<!DOCTYPE html>
<html ng-app="myAppModule">
<head>
    <title>Pathfinder Fight Sim</title>
    <!--<script src="angular.min.js"></script>
    <link href="bootstrap.min.css" rel="stylesheet">-->
    <script src="http://ajax.googleapis.com/ajax/libs/angularjs/1.3.15/angular.min.js"></script>
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css" rel="stylesheet">

</head>
<body>
    <div ng-controller="myAppController" class="container" style="padding-top:20px;">
        <div class="form-horizontal">
            <div class="row">
            <h1>Pathfinder Fight Sim</h1>
            <div class="alert alert-info"><h1>{{ result }}</h1></div>
                <div class="col-lg-4">
                    <div class="form-group">
                        <button class="btn btn-primary" ng-click="runBattle()">Fight!</button>
                    </div>
                </div>
            </div>
                <div class="row">
                    <div class="col-lg-4">
                        <div class="row">
                            <h2>Player 1</h2>
                            <div class="form-group">
                                <label class="control-label col-lg-4">Name:</label>
                                <div class="col-md-6 col-lg-8">
                                    <input type="text" ng-model="players[0].Name" class="form-control" />
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="form-group">
                                <label class="control-label col-lg-4">HP:</label>
                                <div class="col-md-6 col-lg-8">
                                    <input type="text" ng-model="players[0].HP" digits class="form-control" />
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="form-group">
                                <label class="control-label col-lg-4">Strength:</label>
                                <div class="col-md-6 col-lg-8">
                                    <input type="text" ng-model="players[0].Strength" digits class="form-control" />
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="form-group">
                                <label class="control-label col-lg-4">CMB:</label>
                                <div class="col-md-6 col-lg-8">
                                    <input type="text" ng-model="players[0].CMB" digits class="form-control" />
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="form-group">
                                <label class="control-label col-lg-4">AC:</label>
                                <div class="col-md-6 col-lg-8">
                                    <input type="text" ng-model="players[0].AC" digits class="form-control" />
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="form-group">
                                <label class="control-label col-lg-4">Attacks:</label>
                                <div class="col-md-6 col-lg-8">
                                    <input type="text" ng-model="players[0].Attacks" digits class="form-control" />
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="form-group">
                                <label class="control-label col-lg-4">No. Damage Dice:</label>
                                <div class="col-md-6 col-lg-8">
                                    <input type="text" ng-model="players[0].DamageDiceNumber" digits class="form-control" />
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="form-group">
                                <label class="control-label col-lg-4">Damage Dice Type :</label>
                                <div class="col-md-6 col-lg-8">
                                    <input type="text" ng-model="players[0].DamageDiceValue" digits class="form-control" />
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-4">
                        <div class="row">
                            <h2>Player 2</h2>
                            <div class="form-group">
                                <label class="control-label col-lg-4">Name:</label>
                                <div class="col-md-6 col-lg-8">
                                    <input type="text" ng-model="players[1].Name" class="form-control" />
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="form-group">
                                <label class="control-label col-lg-4">HP:</label>
                                <div class="col-md-6 col-lg-8">
                                    <input type="text" ng-model="players[1].HP" digits class="form-control" />
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="form-group">
                                <label class="control-label col-lg-4">Strength:</label>
                                <div class="col-md-6 col-lg-8">
                                    <input type="text" ng-model="players[1].Strength" digits class="form-control" />
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="form-group">
                                <label class="control-label col-lg-4">CMB:</label>
                                <div class="col-md-6 col-lg-8">
                                    <input type="text" ng-model="players[1].CMB" digits class="form-control" />
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="form-group">
                                <label class="control-label col-lg-4">AC:</label>
                                <div class="col-md-6 col-lg-8">
                                    <input type="text" ng-model="players[1].AC" digits class="form-control" />
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="form-group">
                                <label class="control-label col-lg-4">Attacks:</label>
                                <div class="col-md-6 col-lg-8">
                                    <input type="text" ng-model="players[1].Attacks" digits class="form-control" />
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="form-group">
                                <label class="control-label col-lg-4">No. Damage Dice:</label>
                                <div class="col-md-6 col-lg-8">
                                    <input type="text" ng-model="players[1].DamageDiceNumber" digits class="form-control" />
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="form-group">
                                <label class="control-label col-lg-4">Damage Dice Type :</label>
                                <div class="col-md-6 col-lg-8">
                                    <input type="text" ng-model="players[1].DamageDiceValue" digits class="form-control" />
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-4">
                        <h2>Battle Report</h2>
                        <div data-ng-repeat="i in rounds track by $index">
                            <div>{{ i }}</div>
                        </div>
                    </div>

                </div>
            </div>
	

    <script type="text/javascript">


        var myAppModule = angular.module('myAppModule', []);
        myAppModule.controller('myAppController', function ($scope) {
            $scope.result = "FIGHT!";

            var players = [];

            var player1 = {
                Name: "Gronk",
                GroupSize : 1,
                HP: 48,
                Strength: 5,
                CMB : 8,
                AC: 21,
                Attacks: 1,
                DamageDiceNumber: 1,
                DamageDiceValue: 6
            };
            players.push(player1);

            var player2 = {
                Name: "Sheida",
                GroupSize: 1,
                HP: 22,
                Strength: 3,
                CMB : 9,
                AC: 20,
                Attacks: 2,
                DamageDiceNumber: 1,
                DamageDiceValue: 6
        };

            players.push(player2);

            $scope.players = players;

            $scope.runBattle = function () {
                var rounds = [];
                var run = true;
                var HPs = [];
                HPs[0] = $scope.players[0].HP;
                HPs[1] = $scope.players[1].HP;
                var a;
                while(run)
                {
                    //p1
                    //for each atack role to hit d20 + CMD => p2.AC == hit
                    var Critical;
                    var Confirm;
                    for (var i = 0; i < parseInt($scope.players[0].Attacks); i++) {
                        Critical = false;
                        Confirm = false;
                        var AttackRole = Math.floor((Math.random() * 20) + 1);
                        Critical = (AttackRole == 20);
                        if (Critical)
                        {
                            //Confirm
                            rounds.push($scope.players[0].Name + " Attack Role: " + AttackRole + " (CRITICAL HIT!)");
                            var ConfirmRole = Math.floor((Math.random() * 20) + 1);
                            Confirm = (ConfirmRole == 20);
                            if (Confirm)
                            {
                                rounds.push($scope.players[0].Name + " Confirm Role: " + ConfirmRole + " (CONFIRMED!!)");
                            }
                            else
                            {
                                rounds.push($scope.players[0].Name + " Confirm Role: " + ConfirmRole + " (MISS)");
                            }
                            
                        }
                        var hit = false;
                        if (Critical)
                        {
                            hit = true;
                        }
                        else
                        {
                            hit = (parseInt(AttackRole) + parseInt($scope.players[0].CMB)) >= parseInt($scope.players[1].AC);
                            rounds.push($scope.players[0].Name + " Attack Role: " + AttackRole + " (" + (hit ? "HIT" : "MISS") + ")");
                        }
                        if (hit)
                        {
                            //roll to damage
                            var DamageRoll = 0;
                            var Damage = 0;
                            for (var x = 0; x < parseInt($scope.players[0].DamageDiceNumber) ; x++) {
                                DamageRoll += Math.floor((Math.random() * parseInt($scope.players[0].DamageDiceValue)) + 1);
                            }
                            Damage = DamageRoll + parseInt($scope.players[0].Strength);
                            if (Confirm) Damage = Damage * 2;
                            rounds.push($scope.players[0].Name + " Damage Role: " + (Damage) + " (" + (DamageRoll) + ")");
                            HPs[1] -= Damage;
                            rounds.push($scope.players[1].Name + " HP: " + HPs[1]);
                        }
                    }
                    if (HPs[1] > 0)
                    {
                        for (var i = 0; i < parseInt($scope.players[1].Attacks); i++) {
                            Critical = false;
                            Confirm = false;
                            var AttackRole = Math.floor((Math.random() * 20) + 1);
                            Critical = (AttackRole == 20);
                            if (Critical) {
                                //Confirm
                                rounds.push($scope.players[1].Name + " Attack Role: " + AttackRole + " (CRITICAL HIT!)");
                                var ConfirmRole = Math.floor((Math.random() * 20) + 1);
                                Confirm = (ConfirmRole == 20);
                                if (Confirm) {
                                    rounds.push($scope.players[1].Name + " Confirm Role: " + ConfirmRole + " (CONFIRMED!!)");
                                }
                                else {
                                    rounds.push($scope.players[1].Name + " Confirm Role: " + ConfirmRole + " (MISS)");
                                }

                            }
                            var hit = false;
                            if (Critical) {
                                hit = true;
                            }
                            else {
                                hit = (parseInt(AttackRole) + parseInt($scope.players[1].CMB)) >= parseInt($scope.players[0].AC);
                                rounds.push($scope.players[1].Name + " Attack Role: " + AttackRole + " (" + (hit ? "HIT" : "MISS") + ")");
                            }
                            if (hit)
                                if ((parseInt(AttackRole) + parseInt($scope.players[1].CMB)) >= parseInt($scope.players[0].AC)) {
                                //roll to damage
                                    var DamageRoll = 0;
                                    var Damage = 0;
                                    for (var x = 0; x < parseInt($scope.players[1].DamageDiceNumber); x++) {
                                        DamageRoll += Math.floor((Math.random() * parseInt($scope.players[1].DamageDiceValue)) + 1);
                                    }
                                    Damage = DamageRoll + parseInt($scope.players[1].Strength);
                                    if (Confirm) Damage = Damage * 2;
                                    rounds.push($scope.players[1].Name + " Damage Role: " + (Damage) + " (" + (DamageRoll) + ")");
                                    HPs[0] -= Damage;
                                    rounds.push($scope.players[0].Name + " HP: " + HPs[0]);
                            }
                        }
                        if (HPs[0] <= 0)
                        {
                            run = false;
                        }
                    }
                    else
                    {
                        run = false;
                    }
                }
                $scope.rounds = rounds;
                var winner = HPs[0] > 0 ? $scope.players[0].Name : $scope.players[1].Name;
                $scope.result = winner + " wins!";
			}
        });

		
		myAppModule.filter('subs', function() {
		  return function(input) {
				var result = "";
				if (input > 0)
				{
				var check3 = input % 3;
				var check5 = input % 5;
				var check15 = input % 15;
				
				if (check3 === 0) result = "C";
				if (check5 === 0) result = "E";
				if (check15 === 0) result = "Z";
				if (result === "") result = input;
				}
				else
				{
					result = input;// 0 case
				}
				return result;
			  };
		});

		// Allows only digits in the text input
		myAppModule.directive('digits', function () {
			return {
				restrict: 'A',
				require: '?ngModel',
				link: function (scope, element, attrs, ngModel) {
					if (!ngModel) return;
					ngModel.$parsers.unshift(function (inputValue) {
						var digits = inputValue.split('').filter(function (s) { return (!isNaN(s) && s != ' '); }).join('');
						ngModel.$viewValue = digits;
						ngModel.$render();
						return digits;
					});
				}
			};
		});

		  
    </script>
</body>

</html>

